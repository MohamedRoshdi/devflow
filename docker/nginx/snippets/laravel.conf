# Laravel Application Configuration
# This snippet contains the core Laravel-specific nginx configuration

# Document root
root /var/www/html/public;
index index.php index.html index.htm;

# Character set
charset utf-8;

# Client body size limit (for file uploads)
client_max_body_size 100M;
client_body_buffer_size 128k;

# Timeouts
client_body_timeout 60s;
client_header_timeout 60s;
keepalive_timeout 65s;
send_timeout 60s;

# Buffer settings
client_header_buffer_size 1k;
large_client_header_buffers 4 16k;

# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# Remove X-Powered-By header
fastcgi_hide_header X-Powered-By;

# Gzip compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/atom+xml
    application/rss+xml
    image/svg+xml;
gzip_disable "MSIE [1-6]\.";

# Logging
access_log /var/log/nginx/devflow-access.log;
error_log /var/log/nginx/devflow-error.log warn;

# Main location block - Laravel front controller
location / {
    try_files $uri $uri/ /index.php?$query_string;
}

# Favicon
location = /favicon.ico {
    access_log off;
    log_not_found off;
    expires 30d;
    add_header Cache-Control "public, immutable";
}

# Robots.txt
location = /robots.txt {
    access_log off;
    log_not_found off;
    expires 30d;
}

# PHP-FPM processing
location ~ \.php$ {
    # Security: Don't allow arbitrary file execution
    try_files $uri =404;

    # FastCGI configuration
    fastcgi_pass php-fpm;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;

    # Include standard FastCGI parameters
    include fastcgi_params;

    # FastCGI optimizations
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_buffer_size 128k;
    fastcgi_buffers 256 16k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;
    fastcgi_read_timeout 300s;
    fastcgi_send_timeout 300s;
    fastcgi_connect_timeout 60s;
    fastcgi_intercept_errors on;

    # FastCGI cache (optional, commented by default)
    # fastcgi_cache_bypass $http_pragma $http_authorization;
    # fastcgi_no_cache $http_pragma $http_authorization;
}

# Deny access to hidden files (except .well-known for SSL verification)
location ~ /\.(?!well-known).* {
    deny all;
    access_log off;
    log_not_found off;
}

# Deny access to sensitive files
location ~ /\.(env|git|gitignore|gitattributes|editorconfig) {
    deny all;
    access_log off;
    log_not_found off;
}

# Deny access to configuration files
location ~ /(composer\.(json|lock)|package(-lock)?\.json|phpunit\.xml|artisan|web\.config) {
    deny all;
    access_log off;
    log_not_found off;
}

# Cache static assets
location ~* \.(jpg|jpeg|gif|png|webp|avif|ico|svg|css|js|woff|woff2|ttf|otf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
    access_log off;
    log_not_found off;
}

# Cache media files
location ~* \.(mp4|webm|ogg|mp3|wav|flac|aac)$ {
    expires 7d;
    add_header Cache-Control "public";
    access_log off;
}

# Cache document files
location ~* \.(pdf|doc|docx|xls|xlsx|ppt|pptx)$ {
    expires 7d;
    add_header Cache-Control "public";
    add_header X-Content-Type-Options "nosniff";
}

# Disable access to backup and source files
location ~* (?:\.(?:bak|conf|dist|fla|in[ci]|log|orig|psd|sh|sql|sw[op])|~)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Laravel Storage - Serve files with proper headers
location ^~ /storage {
    alias /var/www/html/storage/app/public;
    expires 30d;
    add_header Cache-Control "public";
    access_log off;

    # Security headers for user uploads
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "SAMEORIGIN";
}
