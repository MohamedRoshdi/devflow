# PostgreSQL Performance Optimization Configuration
# Add these settings to postgresql.conf
# Location: /etc/postgresql/16/main/postgresql.conf or in docker-compose environment

# Memory Settings (adjust based on available RAM)
# For 4GB RAM server:
shared_buffers = 1GB
effective_cache_size = 3GB
maintenance_work_mem = 256MB
work_mem = 16MB

# For 8GB RAM server:
# shared_buffers = 2GB
# effective_cache_size = 6GB
# maintenance_work_mem = 512MB
# work_mem = 32MB

# WAL (Write-Ahead Log) Settings
wal_buffers = 16MB
min_wal_size = 1GB
max_wal_size = 4GB
checkpoint_completion_target = 0.9
wal_compression = on

# Planner Settings
random_page_cost = 1.1  # Lower for SSD
effective_io_concurrency = 200  # Higher for SSD

# Parallel Query Settings
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# Connection Settings
max_connections = 100
shared_preload_libraries = 'pg_stat_statements'

# Logging Settings
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000  # Log queries slower than 1 second
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

# Statement Statistics
pg_stat_statements.track = all
pg_stat_statements.max = 10000

# Auto Vacuum Settings
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 10s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# Lock Management
deadlock_timeout = 1s

# Client Connection Defaults
default_statistics_target = 100
