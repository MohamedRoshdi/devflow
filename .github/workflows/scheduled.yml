name: Scheduled Tasks

on:
  schedule:
    # Run security audit daily at 2 AM UTC
    - cron: '0 2 * * *'
    # Run dependency updates check weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  security-audit:
    name: Daily Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Run Composer security audit
        id: composer-audit
        run: |
          composer audit --format=json > composer-audit.json || true
          cat composer-audit.json

      - name: Install npm dependencies
        run: npm ci

      - name: Run npm security audit
        id: npm-audit
        run: |
          npm audit --json > npm-audit.json || true
          cat npm-audit.json

      - name: Check for critical vulnerabilities
        run: |
          composer_critical=$(jq '.advisories | length' composer-audit.json 2>/dev/null || echo "0")
          npm_critical=$(jq '.metadata.vulnerabilities.critical' npm-audit.json 2>/dev/null || echo "0")

          if [ "$composer_critical" -gt "0" ] || [ "$npm_critical" -gt "0" ]; then
            echo "âš ï¸ Critical security vulnerabilities found!"
            echo "Composer: $composer_critical | npm: $npm_critical"
            exit 1
          fi

      - name: Create security report issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const composerAudit = JSON.parse(fs.readFileSync('composer-audit.json', 'utf8'));
            const npmAudit = JSON.parse(fs.readFileSync('npm-audit.json', 'utf8'));

            const title = `ðŸ”’ Security Audit Alert - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Security Vulnerabilities Detected

            ### Composer Vulnerabilities
            \`\`\`json
            ${JSON.stringify(composerAudit, null, 2)}
            \`\`\`

            ### npm Vulnerabilities
            \`\`\`json
            ${JSON.stringify(npmAudit, null, 2)}
            \`\`\`

            **Action Required:** Please review and update affected packages.

            ---
            *Automated security audit by GitHub Actions*`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated']
            });

  dependency-updates:
    name: Check Dependency Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Composer outdated packages
        run: |
          composer outdated --direct --format=json > composer-outdated.json || true
          cat composer-outdated.json

      - name: Check npm outdated packages
        run: |
          npm outdated --json > npm-outdated.json || true
          cat npm-outdated.json

      - name: Create dependency update issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let composerOutdated = {};
            let npmOutdated = {};

            try {
              composerOutdated = JSON.parse(fs.readFileSync('composer-outdated.json', 'utf8'));
            } catch (e) {}

            try {
              npmOutdated = JSON.parse(fs.readFileSync('npm-outdated.json', 'utf8'));
            } catch (e) {}

            if (Object.keys(composerOutdated).length > 0 || Object.keys(npmOutdated).length > 0) {
              const title = `ðŸ“¦ Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`;
              const body = `## Outdated Dependencies

              ### Composer Packages
              \`\`\`json
              ${JSON.stringify(composerOutdated, null, 2)}
              \`\`\`

              ### npm Packages
              \`\`\`json
              ${JSON.stringify(npmOutdated, null, 2)}
              \`\`\`

              **Recommendation:** Review and update dependencies when appropriate.

              ---
              *Automated dependency check by GitHub Actions*`;

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'automated']
              });
            }

  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Delete old artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '30 days'
          skip-recent: 5

  database-backup:
    name: Database Backup Check
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Verify database backups
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}

            echo "ðŸ—„ï¸ Checking database backup status..."
            php artisan backup:list

            echo "ðŸ“Š Recent backup files:"
            ls -lh storage/app/backups/ | tail -5
          EOF

      - name: Notify backup status
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âš ï¸ Database Backup Check Failed"
          description: "Scheduled backup verification has failed. Please check server logs."
          color: 0xffa500
          username: DevFlow Pro Monitoring
